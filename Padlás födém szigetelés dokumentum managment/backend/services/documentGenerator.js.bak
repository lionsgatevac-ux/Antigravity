const Docxtemplater = require('docxtemplater');
const PizZip = require('pizzip');
const fs = require('fs');
const path = require('path');

// BO-ZSO Hungary Kft fixed data
const CONTRACTOR_DATA = {
    companyName: "BO-ZSO Hungary Kft",
    address: "2133 Sződliget HRSZ 1225/1",
    registrationNumber: "13 09 201060",
    taxNumber: "27030110213",
    statisticsNumber: "27030110-4100-113-13",
    mkikNumber: "26B96372",
    insurancePolicy: "95595005769188500",
    representative: {
        name: "Dobai Tamás",
        birthPlace: "Budapest",
        birthDate: "1979.10.25",
        motherName: "Szolnoki Györgyi Juditt",
        address: "2613 Rád Kossuth utca 20."
    },
    bank: {
        name: "OTP Bank NYRT",
        accountNumber: "11742104-24309413"
    },
    contact: {
        email: "lionsgatevac@gmail.com"
    }
};

class DocumentGenerator {
    constructor() {
        this.templatesDir = path.join(__dirname, '..', '..', 'templates');
        this.generatedDir = path.join(__dirname, '..', 'generated');

        // Ensure generated directory exists
        if (!fs.existsSync(this.generatedDir)) {
            fs.mkdirSync(this.generatedDir, { recursive: true });
        }
    }

    // Format date to Hungarian format
    formatDate(date) {
        if (!date) return '';
        const d = new Date(date);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}.${month}.${day}.`;
    }

    // Format currency
    formatCurrency(amount) {
        if (!amount) return '0 Ft';
        return new Intl.NumberFormat('hu-HU').format(amount) + ' Ft';
    }

    // Generate document from template
    async generate(templateName, data) {
        try {
            // Template path
            const templatePath = path.join(this.templatesDir, `${templateName}.docx`);

            if (!fs.existsSync(templatePath)) {
                throw new Error(`Template not found: ${templateName}`);
            }

            // Load template
            const content = fs.readFileSync(templatePath, 'binary');
            const zip = new PizZip(content);

            // Create docxtemplater instance
            const doc = new Docxtemplater(zip, {
                paragraphLoop: true,
                linebreaks: true,
                delimiters: { start: '[[', end: ']]' }
            });

            // Prepare data with formatting
            const formattedData = this.prepareData(data);

            // Render document
            doc.render(formattedData);

            // Generate buffer
            const buf = doc.getZip().generate({
                type: 'nodebuffer',
                compression: 'DEFLATE'
            });

            // Save file
            const fileName = `${templateName}_${data.contract_number || Date.now()}.docx`;
            const filePath = path.join(this.generatedDir, fileName);
            fs.writeFileSync(filePath, buf);

            return {
                fileName,
                filePath,
                fileUrl: `/generated/${fileName}`
            };
        } catch (error) {
            console.error('Document generation error:', error);

            // LOG ALL ERRORS
            const errorLog = {
                message: error.message,
                stack: error.stack,
                properties: error.properties || {},
                rawError: JSON.stringify(error, Object.getOwnPropertyNames(error))
            };

            try {
                fs.writeFileSync(path.join(__dirname, '../backend_error.json'), JSON.stringify(errorLog, null, 2));
            } catch (writeErr) {
                console.error('Failed to write error log:', writeErr);
            }

            if (error.properties && error.properties.errors) {
                error.properties.errors.forEach(function (error, index) {
                    console.error(`Docxtemplater Error #${index + 1}:`, error);
                });
            }
            throw new Error(`Failed to generate document: ${error.message}`);
        }
    }

    // Format address
    formatAddress(address) {
        if (!address) return '';
        const { postalCode, city, street, houseNumber } = address;
        if (!postalCode && !city && !street && !houseNumber) return typeof address === 'string' ? address : '';
        return `${postalCode || ''} ${city || ''}, ${street || ''} ${houseNumber || ''}`.trim();
    }

    // Prepare and format data for template
    prepareData(data) {
        return {
            // --- HUNGARIAN MAPPING FOR TEMPLATE ---
            // Customer
            nev: data.customer_name || '',
            szuletesnev: data.customer_birth_name || '',
            anyjaneve: data.customer_mother_name || '',
            szig: data.customer_id_number || '',
            lakcim: this.formatAddress(data.customer_address),

            iranyitoszam: data.customer_address?.postalCode || '',
            varos: data.customer_address?.city || '',
            utca: data.customer_address?.street || '',
            hazszam: data.customer_address?.houseNumber || '',

            telefon: data.customer_phone || '',
            telefonszam: data.customer_phone || '',
            email: data.customer_email || '',

            // Property
            cim: this.formatAddress(data.property_address),

            ingatlan_iranyitoszam: data.property_address?.postalCode || '',
            ingatlan_varos: data.property_address?.city || '',
            ingatlan_utca: data.property_address?.street || '',
            ingatlan_hazszam: data.property_address?.houseNumber || '',
            hrsz: data.hrsz || '',
            epiteseve: data.building_year || '',
            epites: data.building_year || '',
            falazat: data.building_type || '',
            ingatlantipusa: data.building_type || '',
            futes: data.heating_type || '',
            szelemen: data.roof_type || '',

            // Technical
            bruttoalapterulet: data.gross_area || 0,
            brszig: data.gross_area || 0,
            kemeny: data.chimney_area || 0,
            padlasfeljaro: data.attic_door_area || 0,
            padlasfeljarominusz: data.attic_door_area || 0,
            egyeb: data.other_deducted_area || 0,
            egyeblevonando: data.other_deducted_area || 0,
            nettoalapterulet: data.net_area || 0,
            nettoszigetelt: data.net_area || 0,
            szigetelesvastagsag: data.insulation_thickness || 25,
            lambda: data.r_value || 6.25,

            // Structure types (marking with X) - FIXED: using correct values
            fa: data.structure_type === 'fa' ? 'X' : '',
            facm: data.structure_type === 'fa' ? data.structure_thickness : '',
            acel: data.structure_type === 'acel' ? 'X' : '',
            acelcm: data.structure_type === 'acel' ? data.structure_thickness : '',
            vasbeton: data.structure_type === 'vasbeton' ? 'X' : '',
            vasbetoncm: data.structure_type === 'vasbeton' ? data.structure_thickness : '',
            monolit: data.structure_type === 'monolit' ? 'X' : '',
            monolitcm: data.structure_type === 'monolit' ? data.structure_thickness : '',

            // Unheated spaces - CRITICAL FIX: using ACCENTED characters to match frontend
            garazs: data.unheated_space_type === 'garázs' ? 'X' : '',
            garazsnm: data.unheated_space_type === 'garázs' ? data.unheated_space_area : '',
            bármi: data.unheated_space_type === 'télikert' ? 'X' : '',
            bárminm: data.unheated_space_type === 'télikert' ? data.unheated_space_area : '',
            egyéb: data.unheated_space_type === 'egyéb' ? 'X' : '',
            egyébnm: data.unheated_space_type === 'egyéb' ? data.unheated_space_area : '',
            egyébnev: data.unheated_space_type === 'egyéb' ? (data.unheated_space_name || '') : '',

            // Dates
            szerzodeskotes: this.formatDate(data.contract_date || new Date()),
            datum: this.formatDate(data.contract_date || new Date()),
            munka_kezdete: this.formatDate(data.work_start_date),
            munka_vege: this.formatDate(data.work_end_date),
            atadas_datum: this.formatDate(data.handover_date),

            // Financial
            szerzodesi_osszeg: this.formatCurrency(data.net_amount),
            szamoltosszeg: this.formatCurrency(data.net_amount),
            szerzodesi_osszeg_betuvel: data.net_amount_words || '',
            szamoltosszegbetuvel: data.net_amount_words || '',
            munkadij: this.formatCurrency(data.labor_cost),
            megtakaritas: data.energy_saving_gj || 0,
            hem: this.formatCurrency(data.hem_value),
            tamogatas: this.formatCurrency(data.government_support),

            // Logic
            padlasfeljaro_szigetelve: data.attic_door_insulated ? 'IGEN' : 'NEM',

            // Signature data (Base64 images)
            // Note: These will be empty strings if no signature, or Base64 image data
            alairasugyfel: data.customer_signature_data || '',
            alairaskivitelezo: data.contractor_signature_data || '',


            // CONTRACTOR DATA
            vallalkozo_nev: CONTRACTOR_DATA.companyName,
            vallalkozo_cim: CONTRACTOR_DATA.address,
            vallalkozo_adoszam: CONTRACTOR_DATA.taxNumber,
            vallalkozo_bankszamla: CONTRACTOR_DATA.bank.accountNumber,
            vallalkozo_kepviselo: CONTRACTOR_DATA.representative.name,

            // Keep English keys for backward compatibility
            contractor_name: CONTRACTOR_DATA.companyName,
            contract_number: data.contract_number || '',
            contract_date: this.formatDate(data.contract_date || new Date()),
            location: data.location || 'Sződliget',
        };
    }
}

module.exports = new DocumentGenerator();
