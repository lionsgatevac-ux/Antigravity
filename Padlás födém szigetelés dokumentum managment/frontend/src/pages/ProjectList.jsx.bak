import React, { useState, useEffect } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import { projectsAPI } from '../services/api';
import { useApp } from '../context/AppContext';
import { useAuth } from '../contexts/AuthContext'; // Import useAuth
import { formatDate, formatCurrency } from '../utils/calculations';
import './ProjectList.css';

const ProjectList = () => {
    const [projects, setProjects] = useState([]);
    const [loading, setLoading] = useState(true);
    const [filter, setFilter] = useState('all');
    const { showToast } = useApp();
    const { user } = useAuth(); // Get user from AuthContext
    const navigate = useNavigate();

    useEffect(() => {
        loadProjects();
    }, [filter]);

    const loadProjects = async () => {
        try {
            setLoading(true);
            const filters = filter !== 'all' ? { status: filter } : {};
            const response = await projectsAPI.getAll(filters);
            setProjects(response.data || []);
        } catch (error) {
            showToast('Hiba a projektek bet√∂lt√©sekor', 'error');
            console.error(error);
        } finally {
            setLoading(false);
        }
    };

    const handleDelete = async (e, id, contractNumber) => {
        e.preventDefault(); // Biztons√°g kedv√©√©rt
        e.stopPropagation(); // Fontos: ne h√≠v√≥djon meg a k√°rtya onClick-je

        if (window.confirm(`Biztosan t√∂r√∂lni szeretn√©d a(z) ${contractNumber} sz√°m√∫ projektet? Ez a m≈±velet nem vonhat√≥ vissza!`)) {
            try {
                await projectsAPI.delete(id);
                setProjects(projects.filter(p => p.id !== id));
                showToast('Projekt sikeresen t√∂r√∂lve', 'success');
            } catch (error) {
                console.error('T√∂rl√©si hiba:', error);
                showToast('Hiba a projekt t√∂rl√©sekor', 'error');
            }
        }
    };

    const getStatusBadge = (status) => {
        const badges = {
            draft: { label: 'Tervezet', class: 'status-draft' },
            in_progress: { label: 'Folyamatban', class: 'status-progress' },
            completed: { label: 'Befejezett', class: 'status-completed' },
            signed: { label: 'Al√°√≠rt', class: 'status-signed' }
        };
        const badge = badges[status] || badges.draft;
        return <span className={`status-badge ${badge.class}`}>{badge.label}</span>;
    };

    if (loading) {
        return (
            <div className="loading-container">
                <div className="spinner"></div>
                <p>Projektek bet√∂lt√©se...</p>
            </div>
        );
    }

    return (
        <div className="project-list">
            <div className="page-header">
                <h1>Projektek</h1>
                <Link to="/new-project" className="btn btn-primary">
                    ‚ûï √öj Projekt
                </Link>
            </div>

            <div className="filters">
                <button
                    className={`filter-btn ${filter === 'all' ? 'active' : ''}`}
                    onClick={() => setFilter('all')}
                >
                    √ñsszes
                </button>
                <button
                    className={`filter-btn ${filter === 'draft' ? 'active' : ''}`}
                    onClick={() => setFilter('draft')}
                >
                    Tervezet
                </button>
                <button
                    className={`filter-btn ${filter === 'in_progress' ? 'active' : ''}`}
                    onClick={() => setFilter('in_progress')}
                >
                    Folyamatban
                </button>
                <button
                    className={`filter-btn ${filter === 'completed' ? 'active' : ''}`}
                    onClick={() => setFilter('completed')}
                >
                    Befejezett
                </button>
            </div>

            {projects.length === 0 ? (
                <div className="empty-state card">
                    <div className="empty-icon">üìã</div>
                    <h3>Nincs megjelen√≠thet≈ë projekt</h3>
                    <p>Kezdj el egy √∫j projektet a fenti gombbal!</p>
                </div>
            ) : (
                <div className="projects-grid">
                    {projects.map((project) => (
                        <div
                            key={project.id}
                            onClick={() => navigate(`/projects/${project.id}`)}
                            className="project-card card"
                            style={{ cursor: 'pointer' }} // Ensure pointer cursor
                        >
                            <div className="project-header">
                                <h3>{project.contract_number}</h3>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                    {getStatusBadge(project.status)}
                                    {user?.role === 'admin' && (
                                        <button
                                            className="delete-btn"
                                            onClick={(e) => handleDelete(e, project.id, project.contract_number)}
                                            title="Projekt t√∂rl√©se"
                                        >
                                            üóëÔ∏è
                                        </button>
                                    )}
                                </div>
                            </div>



                            <div className="project-info">
                                <div className="info-row">
                                    <span className="label">√úgyf√©l:</span>
                                    <span className="value">{project.customer_name || 'N/A'}</span>
                                </div>
                                <div className="info-row">
                                    <span className="label">Ter√ºlet:</span>
                                    <span className="value">{project.net_area ? `${project.net_area} m¬≤` : 'N/A'}</span>
                                </div>
                                <div className="info-row">
                                    <span className="label">L√©trehozva:</span>
                                    <span className="value">{formatDate(project.created_at)}</span>
                                </div>
                                {project.owner_company && (
                                    <div className="info-row">
                                        <span className="label">Kivitelez≈ë:</span>
                                        <span className="value text-blue-400">{project.owner_company}</span>
                                    </div>
                                )}
                            </div>
                        </Link>
                    ))}
                </div>
            )}
        </div>
    );
};

export default ProjectList;
